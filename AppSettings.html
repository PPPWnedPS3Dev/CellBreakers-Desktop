<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CellBreakers Desktop - Settings</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    * {margin:0; padding:0; box-sizing:border-box;}
    body {
      font-family: 'Segoe UI', sans-serif;
      overflow: hidden;
      background: linear-gradient(135deg, #00111a, #003366);
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      color: white;
    }
    body.light {
      color: black;
    }
    canvas#particles {position:absolute; top:0; left:0; width:100%; height:100%; z-index:0;}
    .container {position:relative; z-index:1; text-align:center; width: 80%; max-width: 800px;}
    h1 {font-size:2.5rem; letter-spacing:2px; text-shadow: 0 0 10px rgba(0,0,0,0.7); margin-bottom:30px;}
    .setting {background: rgba(0,0,0,0.6); padding:15px 20px; margin:10px 0; border-radius:8px; display:flex; justify-content: space-between; align-items:center;}
    .setting.light {background: rgba(255,255,255,0.6);}
    .setting label {font-size:1.1rem;}
    select, button, input {padding:5px 10px; border-radius:5px; border:none;}
    button {cursor:pointer; background:#0077ff; color:white; font-weight:bold; transition:0.3s;}
    button:hover {background:#00aaff;}
    button.light {color: black;}
    .color-options {display:flex; gap:10px; flex-wrap: wrap; margin-top:10px;}
    .color-box {width:40px; height:40px; border-radius:5px; cursor:pointer; border:2px solid rgba(255,255,255,0.3); transition:0.3s;}
    .color-box.selected {border-color:#fff;}
    .plugin-list {display: flex; flex-direction: column; gap: 10px;}
    .plugin-item {display: flex; justify-content: space-between; align-items: center;}
    .plugin-form {display: flex; flex-direction: column; gap: 10px; margin-top: 20px;}
    .plugin-form input {margin-bottom: 10px;}
  </style>
</head>
<body>
  <canvas id="particles"></canvas>
  <div class="container">
    <h1>Settings</h1>
    <div class="setting" id="backgroundSetting">
      <label>Change Background</label>
      <div class="color-options">
        <div class="color-box" data-color="#00111a,#003366" style="background:linear-gradient(135deg, #00111a, #003366)"></div>
        <div class="color-box" data-color="#330000,#660000" style="background:linear-gradient(135deg, #330000, #660000)"></div>
        <div class="color-box" data-color="#003300,#006600" style="background:linear-gradient(135deg, #003300, #006600)"></div>
        <div class="color-box" data-color="#330033,#660066" style="background:linear-gradient(135deg, #330033, #660066)"></div>
        <div class="color-box" data-color="#666600,#cccc00" style="background:linear-gradient(135deg, #666600, #cccc00)"></div>
        <div class="color-box" data-color="#666666,#aaaaaa" style="background:linear-gradient(135deg, #666666, #aaaaaa)"></div>
      </div>
    </div>
    <div class="setting">
      <label>Enable Particles</label>
      <input type="checkbox" id="particlesToggle">
    </div>
    <div class="setting">
      <label>Enable Animations</label>
      <input type="checkbox" id="animationsToggle">
    </div>
    <div class="setting">
      <label>Enable Beta Updates</label>
      <input type="checkbox" id="BetaToggle">
    </div>
    <div class="setting">
      <label>UI Theme</label>
      <select id="themeSelect">
        <option value="dark">Dark</option>
        <option value="light">Light</option>
      </select>
    </div>
    <div class="setting">
      <label>Language</label>
      <select id="languageSelect">
        <option value="en">English</option>
        <option value="fr">French</option>
        <option value="de">German</option>
        <option value="es">Spanish</option>
      </select>
    </div>
    <div class="setting">
      <label>Toggle Offline Mode</label>
      <input type="checkbox" id="OfflineToggle">
    </div>
    <div class="setting">
      <label>Display Mode</label>
      <select id="displayModeSelect">
        <option value="oled">OLED Ultra Black Mode</option>
        <option value="dark">Dark Mode</option>
        <option value="original">Original Theme</option>
      </select>
    </div>
    <div class="setting">
      <label>Plugins Management</label>
    </div>
    <div class="setting plugin-list" id="pluginList">
      <!-- Plugin items will be added here -->
    </div>
    <div class="setting">
      <button id="installPluginBtn">Install Plugin</button>
    </div>
    <div class="setting">
      <button id="applyBtn">Apply</button>
      <button id="restoreBtn">Restore Defaults</button>
    </div>
    <div class="setting">
      <button onclick="window.location.href='index.html'">Back to Home</button>
    </div>
    <div class="setting" id="updateSetting">
      <label>Updates</label>
      <button id="checkUpdateBtn">Check for Updates</button>
      <div id="updateInfo" style="margin-top:10px;"></div>
    </div>
  </div>
  <script>
    const canvas = document.getElementById('particles');
    let enableParticles = false;

    function initParticles() {
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      let particles = [];
      for (let i = 0; i < 100; i++) {
        particles.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          r: Math.random() * 2 + 1,
          vx: Math.random() * 2 - 1,
          vy: Math.random() * 2 - 1
        });
      }

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (!enableParticles) {
          requestAnimationFrame(draw);
          return;
        }
        ctx.fillStyle = 'rgba(255,255,255,0.5)';
        particles.forEach(p => {
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
          ctx.fill();
          p.x += p.vx;
          p.y += p.vy;
          if (p.x < 0 || p.x > canvas.width) p.vx = -p.vx;
          if (p.y < 0 || p.y > canvas.height) p.vy = -p.vy;
        });
        requestAnimationFrame(draw);
      }
      draw();
    }

    window.addEventListener('resize', () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    });

    const colorBoxes = document.querySelectorAll('.color-box');
    const settingsElements = document.querySelectorAll('.setting');

    function applyDisplayMode(mode) {
      const backgroundSetting = document.getElementById('backgroundSetting');
      let bg;
      if (mode !== 'original') {
        backgroundSetting.style.display = 'none';
        if (mode === 'dark') {
          bg = '#111111,#333333';
        } else if (mode === 'oled') {
          bg = '#000000,#000000';
        }
      } else {
        backgroundSetting.style.display = 'flex';
        const selectedBg = document.querySelector('.color-box.selected')?.dataset.color || '#00111a,#003366';
        bg = selectedBg;
      }
      document.body.style.background = bg.includes(',') ? `linear-gradient(135deg, ${bg})` : bg;
    }

    function applyUITheme(theme) {
      if (theme === 'light') {
        document.body.classList.add('light');
        settingsElements.forEach(el => el.classList.add('light'));
      } else {
        document.body.classList.remove('light');
        settingsElements.forEach(el => el.classList.remove('light'));
      }
    }

    function applyParticles(enabled) {
      enableParticles = enabled;
      canvas.style.display = enabled ? 'block' : 'none';
    }

    function loadSettings() {
      const settings = getSettings();
      document.getElementById('particlesToggle').checked = settings.particles ?? true;
      document.getElementById('animationsToggle').checked = settings.animations ?? true;
      document.getElementById('BetaToggle').checked = settings.beta ?? false;
      document.getElementById('themeSelect').value = settings.theme ?? 'dark';
      document.getElementById('languageSelect').value = settings.language ?? 'en';
      document.getElementById('OfflineToggle').checked = settings.offline ?? false;
      document.getElementById('displayModeSelect').value = settings.displayMode ?? 'original';

      applyUITheme(settings.theme ?? 'dark');
      applyDisplayMode(settings.displayMode ?? 'original');

      // Select the correct color box if original
      if (settings.displayMode === 'original') {
        const bg = settings.bg ?? '#00111a,#003366';
        colorBoxes.forEach(box => {
          box.classList.remove('selected');
          if (box.dataset.color === bg) box.classList.add('selected');
        });
      }

      applyParticles(settings.particles ?? true);
    }

    // Preview changes on select/change
    document.getElementById('displayModeSelect').addEventListener('change', function() {
      applyDisplayMode(this.value);
    });

    document.getElementById('themeSelect').addEventListener('change', function() {
      applyUITheme(this.value);
    });

    document.getElementById('particlesToggle').addEventListener('change', function() {
      applyParticles(this.checked);
    });

    colorBoxes.forEach(box => {
      box.addEventListener('click', () => {
        colorBoxes.forEach(b => b.classList.remove('selected'));
        box.classList.add('selected');
        // Preview background if original mode
        if (document.getElementById('displayModeSelect').value === 'original') {
          const bg = box.dataset.color;
          document.body.style.background = `linear-gradient(135deg, ${bg})`;
        }
      });
    });

    document.getElementById('applyBtn').addEventListener('click', () => {
      const settings = getSettings();
      const mode = document.getElementById('displayModeSelect').value;
      if (mode === 'original') {
        const selectedBg = document.querySelector('.color-box.selected')?.dataset.color;
        settings.bg = selectedBg ?? '#00111a,#003366';
      }
      settings.particles = document.getElementById('particlesToggle').checked;
      settings.animations = document.getElementById('animationsToggle').checked;
      settings.beta = document.getElementById('BetaToggle').checked;
      settings.theme = document.getElementById('themeSelect').value;
      settings.language = document.getElementById('languageSelect').value;
      settings.offline = document.getElementById('OfflineToggle').checked;
      settings.displayMode = mode;
      saveSettings(settings);
      loadSettings(); // Reapply from saved
      if (settings.beta && confirm('Beta Updates enabled. Download latest beta?')) {
        alert('Downloading Beta Updates... (placeholder)');
      }
      alert('Settings Applied!');
    });

    document.getElementById('restoreBtn').addEventListener('click', () => {
      const defaultSettings = {
        bg: "#00111a,#003366",
        particles: true,
        animations: true,
        beta: false,
        theme: "dark",
        language: "en",
        offline: false,
        displayMode: "original"
      };
      saveSettings(defaultSettings);
      loadSettings();
      alert('Defaults Restored!');
    });

    // --- GitHub Update Check ---
    const checkBtn = document.getElementById('checkUpdateBtn');
    const updateInfo = document.getElementById('updateInfo');
    checkBtn.addEventListener('click', async () => {
      updateInfo.textContent = 'Checking for updates...';
      const result = await window.updateAPI.check();
      if (result.error) {
        updateInfo.textContent = 'Error: ' + result.error;
        return;
      }
      const latestVersion = result.tag_name;
      const currentVersion = 'Alpha 1';
      if (latestVersion !== currentVersion) {
        updateInfo.innerHTML = `
          New version available: ${latestVersion} <br>
          <a href="${result.html_url}" target="_blank">Download</a>
          <pre>${result.body}</pre>
        `;
      } else {
        updateInfo.textContent = 'You are on the latest version.';
      }
    });

    // Plugin Management
    function getSettings() {
      return localStorage.getItem('settings') ? JSON.parse(localStorage.getItem('settings')) : {};
    }

    function saveSettings(settings) {
      localStorage.setItem('settings', JSON.stringify(settings));
    }

    function getPlugins() {
      return localStorage.getItem('plugins') ? JSON.parse(localStorage.getItem('plugins')) : [];
    }

    function savePlugins(plugins) {
      localStorage.setItem('plugins', JSON.stringify(plugins));
    }

    function loadPlugins() {
      const pluginList = document.getElementById('pluginList');
      pluginList.innerHTML = '';
      const plugins = getPlugins();
      plugins.forEach((plugin, index) => {
        const item = document.createElement('div');
        item.classList.add('plugin-item');
        item.innerHTML = `
          <span>${plugin.name}</span>
          <button onclick="removePlugin(${index})">Remove</button>
        `;
        pluginList.appendChild(item);
      });
    }

    window.removePlugin = function(index) {
      let plugins = getPlugins();
      plugins.splice(index, 1);
      savePlugins(plugins);
      loadPlugins();
    }

    document.getElementById('installPluginBtn').addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.cbplugin';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (event) => {
          try {
            const zip = await JSZip.loadAsync(event.target.result);
            const manifestFile = zip.file('manifest.json');
            if (!manifestFile) {
              alert('Missing manifest.json in plugin');
              return;
            }
            const manifestContent = await manifestFile.async('text');
            const manifest = JSON.parse(manifestContent);

            let plugins = getPlugins();

            // Handle different plugin types
            if (manifest.type === 'link') {
              // Custom link
              const pluginData = {
                name: manifest.name,
                icon: manifest.icon || '🔌',
                url: manifest.url,
                external: manifest.external ?? true
              };
              plugins.push(pluginData);
            } else if (manifest.type === 'homebrew') {
              // Custom JSON homebrew list
              const jsonFile = zip.file(manifest.jsonFile || 'list.json');
              if (!jsonFile) {
                alert('Missing homebrew JSON file');
                return;
              }
              const jsonContent = await jsonFile.async('text');
              localStorage.setItem(`homebrew_${manifest.name}`, jsonContent);
              const pluginData = {
                name: manifest.name,
                type: 'homebrew'
              };
              plugins.push(pluginData);
            } else if (manifest.type === 'ui') {
              // Custom UI module - future-proof, store HTML/JS
              const htmlFile = zip.file(manifest.htmlFile || 'module.html');
              const jsFile = zip.file(manifest.jsFile || 'module.js');
              if (!htmlFile) {
                alert('Missing HTML file for UI module');
                return;
              }
              const htmlContent = await htmlFile.async('text');
              let jsContent = '';
              if (jsFile) {
                jsContent = await jsFile.async('text');
              }
              localStorage.setItem(`ui_${manifest.name}_html`, htmlContent);
              localStorage.setItem(`ui_${manifest.name}_js`, jsContent);
              const pluginData = {
                name: manifest.name,
                type: 'ui',
                page: `plugin_${manifest.name}.html` // Placeholder for dynamic page
              };
              plugins.push(pluginData);
              // For future: create dynamic page or load in iframe
            } else {
              alert('Unsupported plugin type');
              return;
            }

            savePlugins(plugins);
            alert('Plugin installed successfully!');
            loadPlugins();
          } catch (error) {
            alert('Error installing plugin: ' + error.message);
          }
        };
        reader.readAsArrayBuffer(file);
      };
      input.click();
    });

    initParticles();
    loadSettings();
    loadPlugins();
  </script>
</body>
</html>